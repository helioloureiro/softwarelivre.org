function updatePriceCompositionBar(e){bar_url=jQuery(e).find(".bar-update-url").val(),jQuery.ajax({url:bar_url,success:function(e){jQuery("#price-composition-bar").html(e)},complete:function(){jQuery("form #product_price").val(currencyToFloat(jQuery("#progressbar-text .product_price").html(),currency_format.separator,currency_format.delimiter)),jQuery("form #product_inputs_cost").val(currencyToFloat(jQuery("#display-product-price-details .inputs-cost span").html(),currency_format.separator,currency_format.delimiter,currency_format.unit)),calculateValuesForBar()}})}function enablePriceDetailSubmit(){jQuery("#manage-product-details-form input.submit").removeAttr("disabled").removeClass("disabled")}function calculateValuesForBar(){jQuery(".cancel-price-details").addClass("form-changed");var e=parseFloat(jQuery("form #product_price").val())||0,r=parseFloat(jQuery("form #product_inputs_cost").val())||0;jQuery("form .price-details-price").each(function(){var e=parseFloat(jQuery(this).val().replace(currency_format.separator,"."))||0;r+=e}),enablePriceDetailSubmit();var t=e-r==0,a=100*r/e;priceCompositionBar(a,t,r,e)}function addCommas(e){e+="";for(var r=e.split("."),t=r[0],a=r.length>1?"."+r[1]:"",i=/(\d+)(\d{3})/;i.test(t);)t=t.replace(i,"$1,$2");return t+a}function floatToCurrency(e,r,t,a){var i="";return a&&(i=a+" "),r||(r="."),t||(t=","),i+addCommas(parseFloat(e).toFixed(2).toString()).replace(".","%sep%").replace(",",t).replace("%sep%",r)}function currencyToFloat(e,r,t,a){var i=e;return a&&(i=i.replace(a+" ","")),r||(r="."),t||(t=","),parseFloat(i.replace(t,"").replace(r,"."))}function productionCostTypeChange(e,r,t,a){if(""==e.value){var i=prompt(t);i&&jQuery.ajax({url:r+"/"+i,dataType:"json",success:function(r){if(r.ok){var t=jQuery('<option value="'+r.id+'">'+i+"</option>");t.insertBefore(jQuery("option:last",e)),e.selectedIndex=e.options.length-2,t.clone().insertBefore("#new-cost-fields .production-cost-selection option:last")}else alert(r.error_msg)},error:function(){alert(a)}})}}function priceCompositionBar(e,r,t,a){jQuery(function(i){var o=i("#price-composition-bar");i(o).find("#progressbar").progressbar({value:e}),i(o).find(".production_cost").html(floatToCurrency(t,currency_format.separator,currency_format.delimiter)),i(o).find(".product_price").html(floatToCurrency(a,currency_format.separator,currency_format.delimiter)),r?(i(o).find("#progressbar-icon").addClass("ui-icon-check"),i(o).find("#progressbar-icon").attr("title",i("#progressbar-icon").attr("data-price-described-message")),i(o).find("div.ui-progressbar-value").addClass("price-described")):(i(o).find("#progressbar-icon").removeClass("ui-icon-check"),i(o).find("#progressbar-icon").attr("title",i("#progressbar-icon").attr("data-price-not-described-message")),i(o).find("div.ui-progressbar-value").removeClass("price-described"))})}!function(e){function r(){e("#manage-product-details-button").show(),e("#display-price-details").show(),e("#display-manage-price-details").html("")}e("#manage-product-details-button").live("click",function(){return e("#product-price-details").find(".loading-area").addClass("small-loading"),url=e(this).attr("href"),e.get(url,function(r){e("#manage-product-details-button").hide(),e("#display-price-details").hide(),e("#display-manage-price-details").html(r),e("#product-price-details").find(".loading-area").removeClass("small-loading")}),!1}),e(".cancel-price-details").live("click",function(){return e(this).hasClass("form-changed")?confirm(e(this).attr("data-confirm"))&&r():r(),!1}),e("#manage-product-details-form").live("submit",function(){var r=this;e(r).find(".loading-area").addClass("small-loading"),e(r).css("cursor","progress");var t=e.ajax(r.action,{type:"POST",dataType:"html",data:e(r).serialize()});return t.done(function(r){e("#display-manage-price-details").html(r),e("#manage-product-details-button").show()}),t.fail(function(r,t,a){log.error("manage_product_details","Request failed",a),alert("manage_product_details\nRequest failed: "+a+"\n\nPlease, contact the site administrator."),e("#display-manage-price-details .loading-area").hide()}),e("#progressbar-icon").hasClass("ui-icon-check")&&display_notice(e("#progressbar-icon").attr("data-price-described-notice")),!1}),e("#add-new-cost").live("click",function(){return e("#display-product-price-details tbody").append(e("#new-cost-fields tbody").html()),!1}),e(".cancel-new-cost").live("click",function(){return e(this).parents("tr").remove(),calculateValuesForBar(),!1}),e("#product-info-form").live("submit",function(){var e=this;updatePriceCompositionBar(e)}),e("form.edit_input").live("submit",function(){var r=this;return inputs_cost_update_url=e(r).find("#inputs-cost-update-url").val(),e.get(inputs_cost_update_url,function(r){e(".inputs-cost span").html(r)}),updatePriceCompositionBar(r),!1}),e("#manage-product-details-form .price-details-price").live("blur",function(){calculateValuesForBar()})}(jQuery),function(e){function r(r,t){r.clicked=t,e(r).toggleClass("open",t)}e("#product-list .expand-box").live("click",function(){var t=this;return e(".expand-box").each(function(e,a){a!=t&&r(a,!1)}),r(t,!t.clicked),!1}),e("#product-list .float-box").live("click",function(){return!1}),e(document).click(function(t){0==e(t.target).parents(".expand-box").length&&e("#product-list .expand-box").each(function(e,t){r(t,!1)})})}(jQuery),product_categories={autocomplete:{search_url:"",select_url:"",load:function(e){e=jQuery(e),e.autocomplete({minLength:3,selectFirst:!0,source:function(e,r){var t={term:e.term};jQuery.getJSON(product_categories.autocomplete.search_url,t,function(e){r(e)})},focus:function(e,r){return jQuery(this).val(r.item.label),!1},select:function(e,r){jQuery("#categories-container").load(product_categories.autocomplete.select_url,{category_id:r.item.value}),jQuery(this).val("")}})}}},products={};